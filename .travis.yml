language: node_js
node_js:
- 12.18.3

brances:
  only:
  - develop

cache:
  directories: 
    â€“ node_modules

before_install:
- cd server
- openssl aes-256-cbc -K $encrypted_3b9f0b9d36d1_key -iv $encrypted_3b9f0b9d36d1_iv
  -in secrets.tar.enc -out secrets.tar -d
- tar xvf secrets.tar
- npm install
- npm install nodemon --save-dev

before_deploy:
  - rm -rf node_modules
  - mkdir -p before-deploy
  - cp ./../scripts/*.sh before-deploy/
  - cp ./../appspec.yml before-deploy/
  - cd before-deploy && zip -r before-deploy *
  - cd ../ && mkdir -p deploy
  - mv before-deploy/before-deploy.zip deploy/SpringBoot_CI-CD.zip

deploy:
  - provider: s3
    access_key_id: "$AWS_ACCESS_KEY"
    secret_access_key: "$AWS_SECRET_KEY"

    bucket: aws-gyun-s3
    region: ap-northeast-2
    
    skip_cleanup: true
    acl: private
    local_dir: deploy
    wait-until-deployed: true

  - provider: codedeploy
    access_key_id: "$AWS_ACCESS_KEY"
    secret_access_key: "$AWS_SECRET_KEY"

    bucket: aws-gyun-s3
    key: SpringBoot_CI-CD.zip
    bundle_type: zip
    application: Praise
    deployment_group: Praise-Group

    region: ap-northeast-2
    wait-until-deployed: true
    on:
      branch: develop

notification:
  email:
    recipients:
    - wjdrbs966@naver.com
